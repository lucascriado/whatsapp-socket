DROP DATABASE users_api;

CREATE DATABASE users_api;

GRANT ALL PRIVILEGES ON users_api.* TO 'admin'@'localhost';
FLUSH PRIVILEGES;

USE users_api;

CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- UUID único
    username VARCHAR(255) NOT NULL UNIQUE,   -- Nome de usuário único
    password VARCHAR(255) NOT NULL,
    fullname VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,      -- E-mail único
    grupo_id INT DEFAULT NULL                -- Grupo opcional
);

CREATE TABLE users_employees (
    id INT AUTO_INCREMENT PRIMARY KEY,
    cliente_id INT NOT NULL,                          -- FK para o cliente (users)
    grupo_id INT NOT NULL,                            -- herdado do cliente
    uuid VARCHAR(36) NOT NULL UNIQUE,                 -- para identificador global
    fullname VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) DEFAULT NULL,               -- se o funcionário precisar logar
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (cliente_id) REFERENCES users(id) ON DELETE CASCADE
);


CREATE TABLE auth_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,                        -- Chave estrangeira para users(id)
    uuid VARCHAR(36) NOT NULL UNIQUE,            -- UUID único para controle de duplicidade
    auth_token CHAR(64) NOT NULL UNIQUE,         -- Token único de autenticação (SHA-1 ou similar)
    grupo_id VARCHAR(255) DEFAULT NULL,
    fullName VARCHAR(150) COLLATE utf8mb4_general_ci DEFAULT NULL,
    email VARCHAR(200) COLLATE utf8mb4_general_ci DEFAULT NULL,
    pessoa_id INT DEFAULT NULL,
    client_id INT DEFAULT NULL,
    owner_pessoa_id INT DEFAULT NULL,
    remoteOS VARCHAR(50) DEFAULT NULL,
    remoteIP VARCHAR(16) DEFAULT NULL,
    pcName VARCHAR(50) DEFAULT NULL,
    APPVersion INT DEFAULT NULL,
    timelogon INT DEFAULT NULL,
    expirylogon INT DEFAULT NULL,
    blockedsession INT DEFAULT 0,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE permissions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description VARCHAR(255) NOT NULL
);

CREATE TABLE user_permissions (
    user_id INT NOT NULL,
    permission_id INT NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (permission_id) REFERENCES permissions(id),
    PRIMARY KEY (user_id, permission_id)
);

INSERT INTO permissions (name, description) VALUES
('read_system_info', 'Permite leitura de informações do sistema'),
('edit_system_info', 'Permite edição de informações do sistema'),
('remove_system_info', 'Permite remoção de informações do sistema'),
('read_calendar', 'Permite leitura do calendário'),
('edit_calendar', 'Permite edição do calendário'),
('remove_calendar', 'Permite remoção do calendário'),
('read_chat', 'Permite leitura de mensagens no chat corporativo'),
('edit_chat', 'Permite edição de mensagens no chat corporativo'),
('remove_chat', 'Permite remoção de mensagens no chat corporativo'),
('read_people_management', 'Permite leitura de informações de gestão de pessoas'),
('edit_people_management', 'Permite edição de informações de gestão de pessoas'),
('remove_people_management', 'Permite remoção de informações de gestão de pessoas'),
('read_marketing_management', 'Permite leitura de informações de gestão de marketing'),
('edit_marketing_management', 'Permite edição de informações de gestão de marketing'),
('remove_marketing_management', 'Permite remoção de informações de gestão de marketing'),
('read_profile', 'Permite leitura do perfil'),
('edit_profile', 'Permite edição do perfil'),
('remove_profile', 'Permite remoção do perfil'),
('read_office_management', 'Permite leitura de informações de gestão de escritório'),
('edit_office_management', 'Permite edição de informações de gestão de escritório'),
('remove_office_management', 'Permite remoção de informações de gestão de escritório'),
('read_firewall_management', 'Permite leitura de informações de ferramentas de escritório'),
('edit_firewall_management', 'Permite edição de informações de ferramentas de escritório'),
('remove_firewall_management', 'Permite remoção de informações de ferramentas de escritório'),
('read_tools_management', 'Permite leitura de informações de ferramentas de escritório'),
('edit_tools_management', 'Permite edição de informações de ferramentas de escritório');

CREATE TABLE imagens (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id VARCHAR(255),
    hash VARCHAR(40),
    midia_url VARCHAR(255)
);
  
CREATE TABLE mensagens (
  id INT AUTO_INCREMENT PRIMARY KEY,
  participante VARCHAR(255),
  voce BOOLEAN,
  texto TEXT,
  tipo ENUM('enviada', 'recebida', 'audio', 'imagem'),  
  usuario_id VARCHAR(255),           
  data TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  conversa_de_grupo VARCHAR(255) DEFAULT NULL,
  midia_url VARCHAR(255)
);

CREATE TABLE audios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id VARCHAR(255),
    hash VARCHAR(40),
    midia_url VARCHAR(255)
);

CREATE TABLE whatsapp_conexoes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    token VARCHAR(255) NOT NULL UNIQUE,
    grupo_id VARCHAR(255) NOT NULL,
    pasta_auth VARCHAR(255) NOT NULL,
    status VARCHAR(50),
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE whatsapp_conexoes MODIFY COLUMN pasta_auth VARCHAR(255) DEFAULT NULL;
ALTER TABLE whatsapp_conexoes MODIFY grupo_id INT DEFAULT 0;

